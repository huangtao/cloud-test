'use strict';

var _createClass = require('babel-runtime/helpers/create-class')['default'];

var _classCallCheck = require('babel-runtime/helpers/class-call-check')['default'];

var _getIterator = require('babel-runtime/core-js/get-iterator')['default'];

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _asyncbox = require('asyncbox');

var _logger = require('./logger');

var _logger2 = _interopRequireDefault(_logger);

var _path = require('path');

var _path2 = _interopRequireDefault(_path);

var _appiumSupport = require('appium-support');

var _installer = require('./installer');

var REQD_PARAMS = ['adb', 'appPackage', 'appActivity', 'tmpDir', 'apk', 'host', 'systemPort', 'devicePort'];

var SelendroidServer = (function () {
  function SelendroidServer() {
    var opts = arguments.length <= 0 || arguments[0] === undefined ? {} : arguments[0];

    _classCallCheck(this, SelendroidServer);

    var _iteratorNormalCompletion = true;
    var _didIteratorError = false;
    var _iteratorError = undefined;

    try {
      for (var _iterator = _getIterator(REQD_PARAMS), _step; !(_iteratorNormalCompletion = (_step = _iterator.next()).done); _iteratorNormalCompletion = true) {
        var req = _step.value;

        if (!opts || !opts[req]) {
          throw new Error('Option \'' + req + '\' is required!');
        }
        this[req] = opts[req];
      }

      // new package name for repackaged selendroid server
    } catch (err) {
      _didIteratorError = true;
      _iteratorError = err;
    } finally {
      try {
        if (!_iteratorNormalCompletion && _iterator['return']) {
          _iterator['return']();
        }
      } finally {
        if (_didIteratorError) {
          throw _iteratorError;
        }
      }
    }

    this.modServerPkg = 'selendroid.' + this.appPackage;
    // path to the repackaged selendroid server specific to this app
    this.modServerPath = _path2['default'].resolve(this.tmpDir, this.modServerPkg + '.apk');
    this.jwproxy = new _appiumBaseDriver.JWProxy({ host: this.host, port: this.systemPort });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
  }

  _createClass(SelendroidServer, [{
    key: 'prepareModifiedServer',
    value: function prepareModifiedServer() {
      var needsUninstall;
      return _regeneratorRuntime.async(function prepareModifiedServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            needsUninstall = false;
            context$2$0.next = 3;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.exists(this.modServerPath));

          case 3:
            if (context$2$0.sent) {
              context$2$0.next = 7;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.buildNewModServer());

          case 6:
            needsUninstall = true;

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.checkAndSignCert(this.modServerPath));

          case 9:
            context$2$0.t0 = context$2$0.sent;

            if (context$2$0.t0) {
              context$2$0.next = 12;
              break;
            }

            context$2$0.t0 = needsUninstall;

          case 12:
            needsUninstall = context$2$0.t0;

            if (!needsUninstall) {
              context$2$0.next = 17;
              break;
            }

            _logger2['default'].info("New server was built, uninstalling any instances of it");
            context$2$0.next = 17;
            return _regeneratorRuntime.awrap(this.adb.uninstallApk(this.modServerPkg));

          case 17:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'installModifiedServer',
    value: function installModifiedServer() {
      var installed;
      return _regeneratorRuntime.async(function installModifiedServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.isAppInstalled(this.modServerPkg));

          case 2:
            installed = context$2$0.sent;

            if (installed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.install(this.modServerPath));

          case 6:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'buildNewModServer',
    value: function buildNewModServer() {
      var packageTmpDir, newManifestPath;
      return _regeneratorRuntime.async(function buildNewModServer$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].info('Repackaging selendroid for: \'' + this.appPackage + '\'');
            packageTmpDir = _path2['default'].resolve(this.tmpDir, this.appPackage);
            newManifestPath = _path2['default'].resolve(this.tmpDir, 'AndroidManifest.xml');

            _logger2['default'].info('Creating new manifest: \'' + newManifestPath + '\'');
            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.mkdir(packageTmpDir));

          case 6:
            context$2$0.next = 8;
            return _regeneratorRuntime.awrap(_appiumSupport.fs.copyFile(_installer.SE_MANIFEST_PATH, newManifestPath));

          case 8:
            context$2$0.next = 10;
            return _regeneratorRuntime.awrap(this.adb.initAapt());

          case 10:
            context$2$0.next = 12;
            return _regeneratorRuntime.awrap(this.adb.compileManifest(newManifestPath, this.modServerPkg, this.appPackage));

          case 12:
            context$2$0.next = 14;
            return _regeneratorRuntime.awrap(this.adb.insertManifest(newManifestPath, _installer.SE_APK_PATH, this.modServerPath));

          case 14:
            _logger2['default'].info('Repackaged selendroid ready: \'' + this.modServerPath + '\'');

          case 15:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'checkAndSignCert',
    value: function checkAndSignCert(apk) {
      var signed;
      return _regeneratorRuntime.async(function checkAndSignCert$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            context$2$0.next = 2;
            return _regeneratorRuntime.awrap(this.adb.checkApkCert(apk, this.appPackage));

          case 2:
            signed = context$2$0.sent;

            if (signed) {
              context$2$0.next = 6;
              break;
            }

            context$2$0.next = 6;
            return _regeneratorRuntime.awrap(this.adb.sign(apk));

          case 6:
            return context$2$0.abrupt('return', !signed);

          case 7:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'startSession',
    value: function startSession(caps) {
      var instrumentWith;
      return _regeneratorRuntime.async(function startSession$(context$2$0) {
        var _this = this;

        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            instrumentWith = this.modServerPkg + '/' + 'io.selendroid.server.ServerInstrumentation';

            _logger2['default'].info('Starting selendroid server with instrumentation: ' + ('' + instrumentWith));
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.adb.instrument(this.appPackage, this.appActivity, instrumentWith));

          case 4:

            _logger2['default'].info('Waiting for Selendroid to be online...');
            // wait 20s for Selendroid to be online
            context$2$0.next = 7;
            return _regeneratorRuntime.awrap((0, _asyncbox.retryInterval)(20, 1000, function callee$2$0() {
              return _regeneratorRuntime.async(function callee$2$0$(context$3$0) {
                while (1) switch (context$3$0.prev = context$3$0.next) {
                  case 0:
                    context$3$0.next = 2;
                    return _regeneratorRuntime.awrap(this.jwproxy.command('/status', 'GET'));

                  case 2:
                  case 'end':
                    return context$3$0.stop();
                }
              }, null, _this);
            }));

          case 7:
            context$2$0.next = 9;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/session', 'POST', { desiredCapabilities: caps }));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this);
    }
  }, {
    key: 'deleteSession',
    value: function deleteSession() {
      return _regeneratorRuntime.async(function deleteSession$(context$2$0) {
        while (1) switch (context$2$0.prev = context$2$0.next) {
          case 0:
            _logger2['default'].debug('Deleting Selendroid server session');
            // rely on jwproxy's intelligence to know what we're talking about and
            // delete the current session
            context$2$0.prev = 1;
            context$2$0.next = 4;
            return _regeneratorRuntime.awrap(this.jwproxy.command('/', 'DELETE'));

          case 4:
            context$2$0.next = 9;
            break;

          case 6:
            context$2$0.prev = 6;
            context$2$0.t0 = context$2$0['catch'](1);

            _logger2['default'].warn('Did not get confirmation Selendroid deleteSession worked; ' + ('Error was: ' + context$2$0.t0));

          case 9:
          case 'end':
            return context$2$0.stop();
        }
      }, null, this, [[1, 6]]);
    }
  }]);

  return SelendroidServer;
})();

exports['default'] = SelendroidServer;
module.exports = exports['default'];

// TODO might have a race condition if we try building this with multiple
// sessions at the same time. OTOH we probably want to share the mod
// server...
// TODO this should be internal to adb

// return whether the apk was signed
//# sourceMappingURL=data:application/json;charset=utf8;base64,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QUUsRUFBQyxtQkFBbUIsRUFBRSxJQUFJLEVBQUMsQ0FBQzs7Ozs7OztLQUM1RTs7O1dBRW1COzs7O0FBQ2xCLGdDQUFPLEtBQUssQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDOzs7Ozs2Q0FJM0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLFFBQVEsQ0FBQzs7Ozs7Ozs7OztBQUV6QyxnQ0FBTyxJQUFJLENBQUMsK0ZBQ21CLENBQUMsQ0FBQzs7Ozs7OztLQUVwQzs7O1NBMUZHLGdCQUFnQjs7O3FCQTZGUCxnQkFBZ0IiLCJmaWxlIjoibGliL3NlbGVuZHJvaWQuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBTRV9BUEtfUEFUSCwgU0VfTUFOSUZFU1RfUEFUSCB9IGZyb20gJy4vaW5zdGFsbGVyJztcblxuXG5jb25zdCBSRVFEX1BBUkFNUyA9IFsnYWRiJywgJ2FwcFBhY2thZ2UnLCAnYXBwQWN0aXZpdHknLCAndG1wRGlyJywgJ2FwaycsXG4gICAgICAgICAgICAgICAgICAgICAnaG9zdCcsICdzeXN0ZW1Qb3J0JywgJ2RldmljZVBvcnQnXTtcblxuY2xhc3MgU2VsZW5kcm9pZFNlcnZlciB7XG4gIGNvbnN0cnVjdG9yIChvcHRzID0ge30pIHtcbiAgICBmb3IgKGxldCByZXEgb2YgUkVRRF9QQVJBTVMpIHtcbiAgICAgIGlmICghb3B0cyB8fCAhb3B0c1tyZXFdKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgT3B0aW9uICcke3JlcX0nIGlzIHJlcXVpcmVkIWApO1xuICAgICAgfVxuICAgICAgdGhpc1tyZXFdID0gb3B0c1tyZXFdO1xuICAgIH1cblxuICAgIC8vIG5ldyBwYWNrYWdlIG5hbWUgZm9yIHJlcGFja2FnZWQgc2VsZW5kcm9pZCBzZXJ2ZXJcbiAgICB0aGlzLm1vZFNlcnZlclBrZyA9IGBzZWxlbmRyb2lkLiR7dGhpcy5hcHBQYWNrYWdlfWA7XG4gICAgLy8gcGF0aCB0byB0aGUgcmVwYWNrYWdlZCBzZWxlbmRyb2lkIHNlcnZlciBzcGVjaWZpYyB0byB0aGlzIGFwcFxuICAgIHRoaXMubW9kU2VydmVyUGF0aCA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgYCR7dGhpcy5tb2RTZXJ2ZXJQa2d9LmFwa2ApO1xuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtob3N0OiB0aGlzLmhvc3QsIHBvcnQ6IHRoaXMuc3lzdGVtUG9ydH0pO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuICB9XG5cbiAgYXN5bmMgcHJlcGFyZU1vZGlmaWVkU2VydmVyICgpIHtcbiAgICAvLyBUT0RPIG1pZ2h0IGhhdmUgYSByYWNlIGNvbmRpdGlvbiBpZiB3ZSB0cnkgYnVpbGRpbmcgdGhpcyB3aXRoIG11bHRpcGxlXG4gICAgLy8gc2Vzc2lvbnMgYXQgdGhlIHNhbWUgdGltZS4gT1RPSCB3ZSBwcm9iYWJseSB3YW50IHRvIHNoYXJlIHRoZSBtb2RcbiAgICAvLyBzZXJ2ZXIuLi5cbiAgICBsZXQgbmVlZHNVbmluc3RhbGwgPSBmYWxzZTtcbiAgICBpZiAoIShhd2FpdCBmcy5leGlzdHModGhpcy5tb2RTZXJ2ZXJQYXRoKSkpIHtcbiAgICAgIGF3YWl0IHRoaXMuYnVpbGROZXdNb2RTZXJ2ZXIoKTtcbiAgICAgIG5lZWRzVW5pbnN0YWxsID0gdHJ1ZTtcbiAgICB9XG4gICAgbmVlZHNVbmluc3RhbGwgPSBhd2FpdCB0aGlzLmNoZWNrQW5kU2lnbkNlcnQodGhpcy5tb2RTZXJ2ZXJQYXRoKSB8fCBuZWVkc1VuaW5zdGFsbDtcbiAgICBpZiAobmVlZHNVbmluc3RhbGwpIHtcbiAgICAgIGxvZ2dlci5pbmZvKFwiTmV3IHNlcnZlciB3YXMgYnVpbHQsIHVuaW5zdGFsbGluZyBhbnkgaW5zdGFuY2VzIG9mIGl0XCIpO1xuICAgICAgYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKHRoaXMubW9kU2VydmVyUGtnKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBpbnN0YWxsTW9kaWZpZWRTZXJ2ZXIgKCkge1xuICAgIGxldCBpbnN0YWxsZWQgPSBhd2FpdCB0aGlzLmFkYi5pc0FwcEluc3RhbGxlZCh0aGlzLm1vZFNlcnZlclBrZyk7XG4gICAgaWYgKCFpbnN0YWxsZWQpIHtcbiAgICAgIGF3YWl0IHRoaXMuYWRiLmluc3RhbGwodGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBidWlsZE5ld01vZFNlcnZlciAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnaW5nIHNlbGVuZHJvaWQgZm9yOiAnJHt0aGlzLmFwcFBhY2thZ2V9J2ApO1xuICAgIGxldCBwYWNrYWdlVG1wRGlyID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCB0aGlzLmFwcFBhY2thZ2UpO1xuICAgIGxldCBuZXdNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsICdBbmRyb2lkTWFuaWZlc3QueG1sJyk7XG4gICAgbG9nZ2VyLmluZm8oYENyZWF0aW5nIG5ldyBtYW5pZmVzdDogJyR7bmV3TWFuaWZlc3RQYXRofSdgKTtcbiAgICBhd2FpdCBmcy5ta2RpcihwYWNrYWdlVG1wRGlyKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShTRV9NQU5JRkVTVF9QQVRILCBuZXdNYW5pZmVzdFBhdGgpO1xuICAgIGF3YWl0IHRoaXMuYWRiLmluaXRBYXB0KCk7IC8vIFRPRE8gdGhpcyBzaG91bGQgYmUgaW50ZXJuYWwgdG8gYWRiXG4gICAgYXdhaXQgdGhpcy5hZGIuY29tcGlsZU1hbmlmZXN0KG5ld01hbmlmZXN0UGF0aCwgdGhpcy5tb2RTZXJ2ZXJQa2csXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuYXBwUGFja2FnZSk7XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zZXJ0TWFuaWZlc3QobmV3TWFuaWZlc3RQYXRoLCBTRV9BUEtfUEFUSCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm1vZFNlcnZlclBhdGgpO1xuICAgIGxvZ2dlci5pbmZvKGBSZXBhY2thZ2VkIHNlbGVuZHJvaWQgcmVhZHk6ICcke3RoaXMubW9kU2VydmVyUGF0aH0nYCk7XG4gIH1cblxuICBhc3luYyBjaGVja0FuZFNpZ25DZXJ0IChhcGspIHtcbiAgICBsZXQgc2lnbmVkID0gYXdhaXQgdGhpcy5hZGIuY2hlY2tBcGtDZXJ0KGFwaywgdGhpcy5hcHBQYWNrYWdlKTtcbiAgICBpZiAoIXNpZ25lZCkge1xuICAgICAgYXdhaXQgdGhpcy5hZGIuc2lnbihhcGspO1xuICAgIH1cblxuICAgIC8vIHJldHVybiB3aGV0aGVyIHRoZSBhcGsgd2FzIHNpZ25lZFxuICAgIHJldHVybiAhc2lnbmVkO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgdmFyIGluc3RydW1lbnRXaXRoID0gYCR7dGhpcy5tb2RTZXJ2ZXJQa2d9L2AgK1xuICAgICAgICAgICAgICAgICAgICAgICAgIGBpby5zZWxlbmRyb2lkLnNlcnZlci5TZXJ2ZXJJbnN0cnVtZW50YXRpb25gO1xuICAgIGxvZ2dlci5pbmZvKGBTdGFydGluZyBzZWxlbmRyb2lkIHNlcnZlciB3aXRoIGluc3RydW1lbnRhdGlvbjogYCArXG4gICAgICAgICAgICAgYCR7aW5zdHJ1bWVudFdpdGh9YCk7XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zdHJ1bWVudCh0aGlzLmFwcFBhY2thZ2UsIHRoaXMuYXBwQWN0aXZpdHksIGluc3RydW1lbnRXaXRoKTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBTZWxlbmRyb2lkIHRvIGJlIG9ubGluZS4uLicpO1xuICAgIC8vIHdhaXQgMjBzIGZvciBTZWxlbmRyb2lkIHRvIGJlIG9ubGluZVxuICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMjAsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIH0pO1xuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZVNlc3Npb24gKCkge1xuICAgIGxvZ2dlci5kZWJ1ZygnRGVsZXRpbmcgU2VsZW5kcm9pZCBzZXJ2ZXIgc2Vzc2lvbicpO1xuICAgIC8vIHJlbHkgb24gandwcm94eSdzIGludGVsbGlnZW5jZSB0byBrbm93IHdoYXQgd2UncmUgdGFsa2luZyBhYm91dCBhbmRcbiAgICAvLyBkZWxldGUgdGhlIGN1cnJlbnQgc2Vzc2lvblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnLycsICdERUxFVEUnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBEaWQgbm90IGdldCBjb25maXJtYXRpb24gU2VsZW5kcm9pZCBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgICAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgU2VsZW5kcm9pZFNlcnZlcjtcbiJdLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
