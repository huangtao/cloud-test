'use strict';

var _regeneratorRuntime = require('babel-runtime/regenerator')['default'];

var _Object$assign = require('babel-runtime/core-js/object/assign')['default'];

var _interopRequireDefault = require('babel-runtime/helpers/interop-require-default')['default'];

Object.defineProperty(exports, '__esModule', {
  value: true
});

var _appiumBaseDriver = require('appium-base-driver');

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _js2xmlparser2 = require("js2xmlparser2");

var _js2xmlparser22 = _interopRequireDefault(_js2xmlparser2);

var _logger = require('../logger');

var _logger2 = _interopRequireDefault(_logger);

var _appiumSupport = require('appium-support');

var _teen_process = require('teen_process');

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

var commands = {},
    helpers = {},
    extensions = {};

commands.active = function callee$0$0() {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 6;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.executeAtom('active_element', []));

      case 3:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getActiveElement()"));

      case 8:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 9:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getDeviceTime = function callee$0$0() {
  var idevicedate, _ref, stdout, date;

  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].info('Attempting to capture iOS device date and time');

        if (!this.isRealDevice()) {
          context$1$0.next = 28;
          break;
        }

        context$1$0.prev = 2;
        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(_appiumSupport.fs.which('idevicedate'));

      case 5:
        idevicedate = context$1$0.sent;

        _logger2['default'].info('Found idevicedate: \'' + idevicedate + '\'');
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap((0, _teen_process.exec)(idevicedate, ['-u', this.opts.udid]));

      case 9:
        _ref = context$1$0.sent;
        stdout = _ref.stdout;

        stdout = stdout.trim();
        context$1$0.prev = 12;
        date = new Date(stdout);
        return context$1$0.abrupt('return', date.toString());

      case 17:
        context$1$0.prev = 17;
        context$1$0.t0 = context$1$0['catch'](12);

        // sometimes `idevicedate` returns an un-parsable format
        // in which case, we just want to return the output and
        // let the client deal with it
        _logger2['default'].debug('Unable to parse date \'' + stdout + '\'. Returning as is');
        return context$1$0.abrupt('return', stdout);

      case 21:
        context$1$0.next = 26;
        break;

      case 23:
        context$1$0.prev = 23;
        context$1$0.t1 = context$1$0['catch'](2);

        _logger2['default'].errorAndThrow('Could not capture device date and time using libimobiledevice idevicedate. ' + 'Libimobiledevice is probably not installed');

      case 26:
        context$1$0.next = 30;
        break;

      case 28:
        _logger2['default'].warn('On simulator. Assuming device time is the same as host time');
        return context$1$0.abrupt('return', new Date().toString());

      case 30:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[2, 23], [12, 17]]);
};

commands.hideKeyboard = function callee$0$0(strategy) {
  for (var _len = arguments.length, possibleKeys = Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {
    possibleKeys[_key - 1] = arguments[_key];
  }

  var cmd, key;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        possibleKeys.pop(); // last parameter is the session id
        cmd = undefined;
        key = _lodash2['default'].find(possibleKeys, function (k) {
          return k;
        });

        if (key) {
          strategy = strategy || 'pressKey';
          cmd = 'au.hideKeyboard(\'' + strategy + '\', \'' + key + '\')';
        } else {
          strategy = strategy || 'default';
          cmd = 'au.hideKeyboard(\'' + strategy + '\')';
        }
        context$1$0.next = 6;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(cmd));

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getPageSource = function callee$0$0() {
  var cmd, jsonSource, xmlSource;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 7;
          break;
        }

        cmd = 'document.getElementsByTagName("html")[0].outerHTML';
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.remote.execute(cmd));

      case 4:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 7:
        context$1$0.next = 9;
        return _regeneratorRuntime.awrap(this.getSourceForElementForXML());

      case 9:
        jsonSource = context$1$0.sent;

        if (typeof jsonSource === "string") {
          jsonSource = JSON.parse(jsonSource);
        }
        xmlSource = (0, _js2xmlparser22['default'])("AppiumAUT", jsonSource, {
          wrapArray: { enabled: false, elementName: "element" },
          declaration: { include: true },
          prettyPrinting: { indentString: "    " }
        });
        return context$1$0.abrupt('return', xmlSource);

      case 13:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.background = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.background(' + secs + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.lock = function callee$0$0(secs) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!secs) {
          _logger2['default'].debug('No seconds parameter. Using 0 seconds');
          secs = 0;
        }
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('au.lock(' + secs + ')'));

      case 3:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.closeApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.stop());

      case 4:
        _logger2['default'].info('Successfully closed the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while closing the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.launchApp = function callee$0$0() {
  var appName;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        appName = this.opts.app || this.opts.bundleId;
        context$1$0.prev = 1;
        context$1$0.next = 4;
        return _regeneratorRuntime.awrap(this.start());

      case 4:
        _logger2['default'].info('Successfully launched the \'' + appName + '\' app.');
        context$1$0.next = 11;
        break;

      case 7:
        context$1$0.prev = 7;
        context$1$0.t0 = context$1$0['catch'](1);

        _logger2['default'].warn('Something went wrong while launching the \'' + appName + '\' app.');
        throw context$1$0.t0;

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this, [[1, 7]]);
};

commands.removeApp = function callee$0$0(bundleId) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isRealDevice()) {
          context$1$0.next = 5;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.realDevice.remove(bundleId));

      case 3:
        context$1$0.next = 7;
        break;

      case 5:
        context$1$0.next = 7;
        return _regeneratorRuntime.awrap(this.sim.removeApp(bundleId));

      case 7:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.keys = function callee$0$0(keys) {
  var el, command;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!this.isWebContext()) {
          context$1$0.next = 10;
          break;
        }

        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(this.active());

      case 3:
        el = context$1$0.sent;

        if (!_lodash2['default'].isUndefined(el.ELEMENT)) {
          context$1$0.next = 6;
          break;
        }

        throw new _appiumBaseDriver.errors.NoSuchElementError();

      case 6:
        context$1$0.next = 8;
        return _regeneratorRuntime.awrap(this.setValue(keys, el.ELEMENT));

      case 8:
        context$1$0.next = 16;
        break;

      case 10:
        if (_lodash2['default'].isArray(keys)) {
          keys = keys.join('');
        }
        if (!_lodash2['default'].isString(keys)) {
          keys = keys.toString();
        }
        keys = _appiumSupport.util.escapeSpecialChars(keys, "'");
        command = 'au.sendKeysToActiveElement(\'' + keys + '\')';
        context$1$0.next = 16;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand(command));

      case 16:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.setGeoLocation = function callee$0$0(location) {
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        context$1$0.next = 2;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand('target.setLocation(' + JSON.stringify(location) + ')'));

      case 2:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

//}
commands.getWindowSize = function callee$0$0() {
  var windowHandle = arguments.length <= 0 || arguments[0] === undefined ? "current" : arguments[0];
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        if (!(windowHandle !== "current")) {
          context$1$0.next = 2;
          break;
        }

        throw new _appiumBaseDriver.errors.NotYetImplementedError("Currently only getting current window size is supported.");

      case 2:
        if (!this.isWebContext()) {
          context$1$0.next = 8;
          break;
        }

        context$1$0.next = 5;
        return _regeneratorRuntime.awrap(this.executeAtom('get_window_size', []));

      case 5:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 8:
        context$1$0.next = 10;
        return _regeneratorRuntime.awrap(this.uiAutoClient.sendCommand("au.getWindowSize()"));

      case 10:
        return context$1$0.abrupt('return', context$1$0.sent);

      case 11:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

commands.getStrings = function callee$0$0(language) {
  var stringFile = arguments.length <= 1 || arguments[1] === undefined ? null : arguments[1];
  var strings;
  return _regeneratorRuntime.async(function callee$0$0$(context$1$0) {
    while (1) switch (context$1$0.prev = context$1$0.next) {
      case 0:
        _logger2['default'].debug('Gettings strings for language \'' + language + '\' and string file \'' + stringFile + '\'');
        context$1$0.next = 3;
        return _regeneratorRuntime.awrap(_utils2['default'].parseLocalizableStrings(_lodash2['default'].defaults({ language: language, stringFile: stringFile }, this.opts)));

      case 3:
        strings = context$1$0.sent;

        if (strings && strings.length >= 1) {
          strings = strings[0];
        }
        return context$1$0.abrupt('return', strings);

      case 6:
      case 'end':
        return context$1$0.stop();
    }
  }, null, this);
};

_Object$assign(extensions, commands, helpers);
exports.commands = commands;
exports.helpers = helpers;
exports['default'] = extensions;

// TODO: check the hasOptions bit, the method signature should be location, option

//let hasOptions = altitude !== null || horizontalAccuracy !== null || verticalAccuracy !== null || course !== null || speed !== null;
//if (hasOptions) {
//let options = {};
//if (altitude !== null) {
//options.altitude = altitude;
//}
//if (horizontalAccuracy !== null) {
//options.horizontalAccuracy = horizontalAccuracy;
//}
//if (verticalAccuracy !== null) {
//options.verticalAccuracy = verticalAccuracy;
//}
//if (course !== null) {
//options.course = course;
//}
//if (speed !== null) {
//options.speed = speed;
//}
//await this.uiAutoClient.sendCommand(
//`target.setLocationWithOptions(${JSON.stringify(coordinates)}, ${JSON.stringify(options)})`);
//} else {
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9nZW5lcmFsLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztnQ0FBdUIsb0JBQW9COztzQkFDN0IsUUFBUTs7Ozs2QkFDSCxlQUFlOzs7O3NCQUNsQixXQUFXOzs7OzZCQUNGLGdCQUFnQjs7NEJBQ3BCLGNBQWM7O3FCQUNqQixVQUFVOzs7O0FBRzVCLElBQUksUUFBUSxHQUFHLEVBQUU7SUFBRSxPQUFPLEdBQUcsRUFBRTtJQUFFLFVBQVUsR0FBRyxFQUFFLENBQUM7O0FBRWpELFFBQVEsQ0FBQyxNQUFNLEdBQUc7Ozs7YUFDWixJQUFJLENBQUMsWUFBWSxFQUFFOzs7Ozs7eUNBQ1IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxnQkFBZ0IsRUFBRSxFQUFFLENBQUM7Ozs7Ozs7eUNBRXRDLElBQUksQ0FBQyxZQUFZLENBQUMsV0FBVyxDQUFDLHVCQUF1QixDQUFDOzs7Ozs7Ozs7O0NBRXRFLENBQUM7O0FBRUYsUUFBUSxDQUFDLGFBQWEsR0FBRztNQUlmLFdBQVcsUUFFVixNQUFNLEVBR0wsSUFBSTs7Ozs7QUFSZCw0QkFBSSxJQUFJLENBQUMsZ0RBQWdELENBQUMsQ0FBQzs7YUFDdkQsSUFBSSxDQUFDLFlBQVksRUFBRTs7Ozs7Ozt5Q0FFSyxrQkFBRyxLQUFLLENBQUMsYUFBYSxDQUFDOzs7QUFBM0MsbUJBQVc7O0FBQ2YsNEJBQUksSUFBSSwyQkFBd0IsV0FBVyxRQUFJLENBQUM7O3lDQUMzQix3QkFBSyxXQUFXLEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQzs7OztBQUF6RCxjQUFNLFFBQU4sTUFBTTs7QUFDWCxjQUFNLEdBQUcsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFDOztBQUVqQixZQUFJLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDOzRDQUNwQixJQUFJLENBQUMsUUFBUSxFQUFFOzs7Ozs7Ozs7QUFLdEIsNEJBQUksS0FBSyw2QkFBMEIsTUFB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Q0FBQyxDQUFDO1FBQ3BDLFFBQVEsR0FBUixRQUFRO1FBQUUsT0FBTyxHQUFQLE9BQU87cUJBQ1gsVUFBVSIsImZpbGUiOiJsaWIvY29tbWFuZHMvZ2VuZXJhbC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGpzMnhtbCBmcm9tIFwianMyeG1scGFyc2VyMlwiO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCB1dGlscyBmcm9tICcuLi91dGlscyc7XG5cblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5hY3RpdmUgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2FjdGl2ZV9lbGVtZW50JywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1LmdldEFjdGl2ZUVsZW1lbnQoKVwiKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0RGV2aWNlVGltZSA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbG9nLmluZm8oJ0F0dGVtcHRpbmcgdG8gY2FwdHVyZSBpT1MgZGV2aWNlIGRhdGUgYW5kIHRpbWUnKTtcbiAgaWYgKHRoaXMuaXNSZWFsRGV2aWNlKCkpIHtcbiAgICB0cnkge1xuICAgICAgbGV0IGlkZXZpY2VkYXRlID0gYXdhaXQgZnMud2hpY2goJ2lkZXZpY2VkYXRlJyk7XG4gICAgICBsb2cuaW5mbyhgRm91bmQgaWRldmljZWRhdGU6ICcke2lkZXZpY2VkYXRlfSdgKTtcbiAgICAgIGxldCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoaWRldmljZWRhdGUsIFsnLXUnLCB0aGlzLm9wdHMudWRpZF0pO1xuICAgICAgc3Rkb3V0ID0gc3Rkb3V0LnRyaW0oKTtcbiAgICAgIHRyeSB7XG4gICAgICAgIGxldCBkYXRlID0gbmV3IERhdGUoc3Rkb3V0KTtcbiAgICAgICAgcmV0dXJuIGRhdGUudG9TdHJpbmcoKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAvLyBzb21ldGltZXMgYGlkZXZpY2VkYXRlYCByZXR1cm5zIGFuIHVuLXBhcnNhYmxlIGZvcm1hdFxuICAgICAgICAvLyBpbiB3aGljaCBjYXNlLCB3ZSBqdXN0IHdhbnQgdG8gcmV0dXJuIHRoZSBvdXRwdXQgYW5kXG4gICAgICAgIC8vIGxldCB0aGUgY2xpZW50IGRlYWwgd2l0aCBpdFxuICAgICAgICBsb2cuZGVidWcoYFVuYWJsZSB0byBwYXJzZSBkYXRlICcke3N0ZG91dH0nLiBSZXR1cm5pbmcgYXMgaXNgKTtcbiAgICAgICAgcmV0dXJuIHN0ZG91dDtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy5lcnJvckFuZFRocm93KCdDb3VsZCBub3QgY2FwdHVyZSBkZXZpY2UgZGF0ZSBhbmQgdGltZSB1c2luZyBsaWJpbW9iaWxlZGV2aWNlIGlkZXZpY2VkYXRlLiAnICtcbiAgICAgICAgICAgICAgICAgICAgICdMaWJpbW9iaWxlZGV2aWNlIGlzIHByb2JhYmx5IG5vdCBpbnN0YWxsZWQnKTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgbG9nLndhcm4oJ09uIHNpbXVsYXRvci4gQXNzdW1pbmcgZGV2aWNlIHRpbWUgaXMgdGhlIHNhbWUgYXMgaG9zdCB0aW1lJyk7XG4gICAgcmV0dXJuIG5ldyBEYXRlKCkudG9TdHJpbmcoKTtcbiAgfVxufTtcblxuY29tbWFuZHMuaGlkZUtleWJvYXJkID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCAuLi5wb3NzaWJsZUtleXMpIHtcbiAgcG9zc2libGVLZXlzLnBvcCgpOyAvLyBsYXN0IHBhcmFtZXRlciBpcyB0aGUgc2Vzc2lvbiBpZFxuICBsZXQgY21kO1xuICBsZXQga2V5ID0gXy5maW5kKHBvc3NpYmxlS2V5cywgKGspID0+IHtyZXR1cm4gazt9KTtcbiAgaWYgKGtleSkge1xuICAgIHN0cmF0ZWd5ID0gc3RyYXRlZ3kgfHwgJ3ByZXNzS2V5JztcbiAgICBjbWQgPSBgYXUuaGlkZUtleWJvYXJkKCcke3N0cmF0ZWd5fScsICcke2tleX0nKWA7XG4gIH0gZWxzZSB7XG4gICAgc3RyYXRlZ3kgPSBzdHJhdGVneSB8fCAnZGVmYXVsdCc7XG4gICAgY21kID0gYGF1LmhpZGVLZXlib2FyZCgnJHtzdHJhdGVneX0nKWA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoY21kKTtcbn07XG5cbmNvbW1hbmRzLmdldFBhZ2VTb3VyY2UgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgbGV0IGNtZCA9ICdkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcImh0bWxcIilbMF0ub3V0ZXJIVE1MJztcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5yZW1vdGUuZXhlY3V0ZShjbWQpO1xuICB9IGVsc2Uge1xuICAgIGxldCBqc29uU291cmNlID0gYXdhaXQgdGhpcy5nZXRTb3VyY2VGb3JFbGVtZW50Rm9yWE1MKCk7XG4gICAgaWYgKHR5cGVvZiBqc29uU291cmNlID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBqc29uU291cmNlID0gSlNPTi5wYXJzZShqc29uU291cmNlKTtcbiAgICB9XG4gICAgbGV0IHhtbFNvdXJjZSA9IGpzMnhtbChcIkFwcGl1bUFVVFwiLCBqc29uU291cmNlLCB7XG4gICAgICB3cmFwQXJyYXk6IHtlbmFibGVkOiBmYWxzZSwgZWxlbWVudE5hbWU6IFwiZWxlbWVudFwifSxcbiAgICAgIGRlY2xhcmF0aW9uOiB7aW5jbHVkZTogdHJ1ZX0sXG4gICAgICBwcmV0dHlQcmludGluZzoge2luZGVudFN0cmluZzogXCIgICAgXCJ9XG4gICAgfSk7XG4gICAgcmV0dXJuIHhtbFNvdXJjZTtcbiAgfVxufTtcblxuY29tbWFuZHMuYmFja2dyb3VuZCA9IGFzeW5jIGZ1bmN0aW9uIChzZWNzKSB7XG4gIGF3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKGBhdS5iYWNrZ3JvdW5kKCR7c2Vjc30pYCk7XG59O1xuXG5jb21tYW5kcy5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKHNlY3MpIHtcbiAgaWYgKCFzZWNzKSB7XG4gICAgbG9nLmRlYnVnKCdObyBzZWNvbmRzIHBhcmFtZXRlci4gVXNpbmcgMCBzZWNvbmRzJyk7XG4gICAgc2VjcyA9IDA7XG4gIH1cbiAgYXdhaXQgdGhpcy51aUF1dG9DbGllbnQuc2VuZENvbW1hbmQoYGF1LmxvY2soJHtzZWNzfSlgKTtcbn07XG5cbmNvbW1hbmRzLmNsb3NlQXBwID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgYXBwTmFtZSA9IHRoaXMub3B0cy5hcHAgfHwgdGhpcy5vcHRzLmJ1bmRsZUlkO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuc3RvcCgpO1xuICAgIGxvZy5pbmZvKGBTdWNjZXNzZnVsbHkgY2xvc2VkIHRoZSAnJHthcHBOYW1lfScgYXBwLmApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cud2FybihgU29tZXRoaW5nIHdlbnQgd3Jvbmcgd2hpbGUgY2xvc2luZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmxhdW5jaEFwcCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgbGV0IGFwcE5hbWUgPSB0aGlzLm9wdHMuYXBwIHx8IHRoaXMub3B0cy5idW5kbGVJZDtcbiAgdHJ5IHtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0KCk7XG4gICAgbG9nLmluZm8oYFN1Y2Nlc3NmdWxseSBsYXVuY2hlZCB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFNvbWV0aGluZyB3ZW50IHdyb25nIHdoaWxlIGxhdW5jaGluZyB0aGUgJyR7YXBwTmFtZX0nIGFwcC5gKTtcbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnJlbW92ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChidW5kbGVJZCkge1xuICBpZiAodGhpcy5pc1JlYWxEZXZpY2UoKSkge1xuICAgIGF3YWl0IHRoaXMucmVhbERldmljZS5yZW1vdmUoYnVuZGxlSWQpO1xuICB9IGVsc2Uge1xuICAgIGF3YWl0IHRoaXMuc2ltLnJlbW92ZUFwcChidW5kbGVJZCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLmtleXMgPSBhc3luYyBmdW5jdGlvbiAoa2V5cykge1xuICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuYWN0aXZlKCk7XG4gICAgaWYgKF8uaXNVbmRlZmluZWQoZWwuRUxFTUVOVCkpIHtcbiAgICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gICAgfVxuICAgIGF3YWl0IHRoaXMuc2V0VmFsdWUoa2V5cywgZWwuRUxFTUVOVCk7XG4gIH0gZWxzZSB7XG4gICAgaWYgKF8uaXNBcnJheShrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMuam9pbignJyk7XG4gICAgfVxuICAgIGlmICghXy5pc1N0cmluZyhrZXlzKSkge1xuICAgICAga2V5cyA9IGtleXMudG9TdHJpbmcoKTtcbiAgICB9XG4gICAga2V5cyA9IHV0aWwuZXNjYXBlU3BlY2lhbENoYXJzKGtleXMsIFwiJ1wiKTtcbiAgICBsZXQgY29tbWFuZCA9IGBhdS5zZW5kS2V5c1RvQWN0aXZlRWxlbWVudCgnJHtrZXlzfScpYDtcbiAgICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChjb21tYW5kKTtcbiAgfVxufTtcblxuY29tbWFuZHMuc2V0R2VvTG9jYXRpb24gPSBhc3luYyBmdW5jdGlvbiAobG9jYXRpb24pIHtcbiAgLy8gVE9ETzogY2hlY2sgdGhlIGhhc09wdGlvbnMgYml0LCB0aGUgbWV0aG9kIHNpZ25hdHVyZSBzaG91bGQgYmUgbG9jYXRpb24sIG9wdGlvblxuXG4gIC8vbGV0IGhhc09wdGlvbnMgPSBhbHRpdHVkZSAhPT0gbnVsbCB8fCBob3Jpem9udGFsQWNjdXJhY3kgIT09IG51bGwgfHwgdmVydGljYWxBY2N1cmFjeSAhPT0gbnVsbCB8fCBjb3Vyc2UgIT09IG51bGwgfHwgc3BlZWQgIT09IG51bGw7XG4gIC8vaWYgKGhhc09wdGlvbnMpIHtcbiAgICAvL2xldCBvcHRpb25zID0ge307XG4gICAgLy9pZiAoYWx0aXR1ZGUgIT09IG51bGwpIHtcbiAgICAgIC8vb3B0aW9ucy5hbHRpdHVkZSA9IGFsdGl0dWRlO1xuICAgIC8vfVxuICAgIC8vaWYgKGhvcml6b250YWxBY2N1cmFjeSAhPT0gbnVsbCkge1xuICAgICAgLy9vcHRpb25zLmhvcml6b250YWxBY2N1cmFjeSA9IGhvcml6b250YWxBY2N1cmFjeTtcbiAgICAvL31cbiAgICAvL2lmICh2ZXJ0aWNhbEFjY3VyYWN5ICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMudmVydGljYWxBY2N1cmFjeSA9IHZlcnRpY2FsQWNjdXJhY3k7XG4gICAgLy99XG4gICAgLy9pZiAoY291cnNlICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuY291cnNlID0gY291cnNlO1xuICAgIC8vfVxuICAgIC8vaWYgKHNwZWVkICE9PSBudWxsKSB7XG4gICAgICAvL29wdGlvbnMuc3BlZWQgPSBzcGVlZDtcbiAgICAvL31cbiAgICAvL2F3YWl0IHRoaXMudWlBdXRvQ2xpZW50LnNlbmRDb21tYW5kKFxuICAgICAgLy9gdGFyZ2V0LnNldExvY2F0aW9uV2l0aE9wdGlvbnMoJHtKU09OLnN0cmluZ2lmeShjb29yZGluYXRlcyl9LCAke0pTT04uc3RyaW5naWZ5KG9wdGlvbnMpfSlgKTtcbiAgLy99IGVsc2Uge1xuICBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChgdGFyZ2V0LnNldExvY2F0aW9uKCR7SlNPTi5zdHJpbmdpZnkobG9jYXRpb24pfSlgKTtcbiAgLy99XG59O1xuXG5jb21tYW5kcy5nZXRXaW5kb3dTaXplID0gYXN5bmMgZnVuY3Rpb24gKHdpbmRvd0hhbmRsZT1cImN1cnJlbnRcIikge1xuICBpZiAod2luZG93SGFuZGxlICE9PSBcImN1cnJlbnRcIikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm90WWV0SW1wbGVtZW50ZWRFcnJvcihcIkN1cnJlbnRseSBvbmx5IGdldHRpbmcgY3VycmVudCB3aW5kb3cgc2l6ZSBpcyBzdXBwb3J0ZWQuXCIpO1xuICB9XG5cbiAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3dpbmRvd19zaXplJywgW10pO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnVpQXV0b0NsaWVudC5zZW5kQ29tbWFuZChcImF1LmdldFdpbmRvd1NpemUoKVwiKTtcbiAgfVxufTtcblxuY29tbWFuZHMuZ2V0U3RyaW5ncyA9IGFzeW5jIGZ1bmN0aW9uIChsYW5ndWFnZSwgc3RyaW5nRmlsZSA9IG51bGwpIHtcbiAgbG9nLmRlYnVnKGBHZXR0aW5ncyBzdHJpbmdzIGZvciBsYW5ndWFnZSAnJHtsYW5ndWFnZX0nIGFuZCBzdHJpbmcgZmlsZSAnJHtzdHJpbmdGaWxlfSdgKTtcbiAgbGV0IHN0cmluZ3MgPSBhd2FpdCB1dGlscy5wYXJzZUxvY2FsaXphYmxlU3RyaW5ncyhfLmRlZmF1bHRzKHtsYW5ndWFnZSwgc3RyaW5nRmlsZX0sIHRoaXMub3B0cykpO1xuICBpZiAoc3RyaW5ncyAmJiBzdHJpbmdzLmxlbmd0aCA+PSAxKSB7XG4gICAgc3RyaW5ncyA9IHN0cmluZ3NbMF07XG4gIH1cbiAgcmV0dXJuIHN0cmluZ3M7XG59O1xuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
